pipeline {
    agent any

    parameters {
        string(name: 'VERSION_TO_UPDATE', description: 'New version to set in all chart.yaml files')
        string(name: 'APP_VERSION_UPDATE', description: 'New appVersion to set in all chart.yaml files')
        string(name: 'SERVICE_LIST_FILE', description: 'YAML file containing services to update')
    }

    environment {
        // Pass new version from Jenkins parameter or calculate dynamicallY
        NEW_VERSION = "${params.VERSION_TO_UPDATE}"
        NEW_APP_VERSION = "${params.APP_VERSION_UPDATE}"
        
    }

    stages {

        stage('Checkout') {
            steps {
                echo "Checkout"
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/main"]],
                    userRemoteConfigs: [[
                        url: 'https://github.com/vishaal99/azure.git',
                        credentialsId: 'github-creds'
                    ]]
                ])
            }
        }
        stage('Update Helm chart versions') {
            steps {
                echo "updating"
                script {
                    
                    
                    // Find every chart.yaml file under the repo and update version + appVersion
                    sh """
                    set -e
                    echo "Reading services from \${SERVICE_LIST_FILE}"

                    # Extract service paths from YAML
                    SERVICES=\$(yq e '.services[]' \${SERVICE_LIST_FILE})
                    for service in \$SERVICES; do
                        CHART_FILE="\$service/Chart.yaml"
                        if [ -f "\$CHART_FILE" ]; then
                            echo "Updating \$CHART_FILE"
                            # Update version
                            echo "Updating all chart.yaml files to version: \${NEW_VERSION}"
                            sed -i "s/^version:.*/version: \${NEW_VERSION}/" "\$CHART_FILE"
                            # Update appVersion
                            echo "Updating all chart.yaml files to appversion: \${NEW_APP_VERSION}"
                            sed -i -E "s/^[[:space:]]*appVersion[[:space:]]*:[[:space:]]*.*/appVersion: \"\${NEW_APP_VERSION}\"/" "\$CHART_FILE"
                        else
                            echo "WARNING: \$CHART_FILE not found"
                        fi
                    done
                    """
                }
            }
        }

        stage('Commit & Push CHANGES') {
            steps {
                echo "pushing"
                withCredentials([string(credentialsId: 'github_pat', variable: 'GITHUB_PAT')]){

                    sh """
                    git config user.email "vishaalaadhityas@gmail.com"
                    git config user.name "vishaal99"
                    git remote set-url origin https://vishaal99:\${GITHUB_PAT}@github.com/vishaal99/azure.git
                    git add .
                    git commit -m "CD: Updated chart version to \${NEW_VERSION} and appVersion to \${NEW_APP_VERSION}" || echo "No changes to commit"
                    # Push only if commit exists
                    git push origin HEAD:refs/heads/main || true
                    """
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline finished."
        }
    }
}
